#!/bin/bash
/usr/local/sys_scripts/bin/git-update-hard /usr/local/sys_scripts master
/usr/local/sys_scripts/bin/git-update-hard /etc/munin master

/usr/local/sys_scripts/bin/aws-update_hosts 75.101.144.164 \
  db.aws.trike.com.au \
  sultana.trike.com.au \
  memcache.aws.trike.com.au

export APPLICATION=lesswrong.com
export APPLICATION_USER=www-data
export APPLICATION_ENV=staging
APP_DIR=/srv/www/lesswrong.com

sudo -u www-data /usr/local/sys_scripts/bin/git-update-hard $APP_DIR/current staging
cd $APP_DIR/current && rake after_update_code > $APP_DIR/shared/log/after_update_code.log 2>&1
cd $APP_DIR/current && rake deploy:restart > $APP_DIR/shared/log/deploy-restart.log 2>&1
sudo -u www-data $APP_DIR/current/scripts/sync_wiki_export.sh

<% if time_to_live > 0 %>
# This server will self destruct in <%= time_to_live %> minutes
# run shutdown -c to cancel
shutdown -h +<%= time_to_live %> &
<% end %>

