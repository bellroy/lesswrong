## The contents of this file are subject to the Common Public Attribution
## License Version 1.0. (the "License"); you may not use this file except in
## compliance with the License. You may obtain a copy of the License at
## http://code.reddit.com/LICENSE. The License is based on the Mozilla Public
## License Version 1.1, but Sections 14 and 15 have been added to cover use of
## software over a computer network and provide for limited attribution for the
## Original Developer. In addition, Exhibit A has been modified to be consistent
## with Exhibit B.
##
## Software distributed under the License is distributed on an "AS IS" basis,
## WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License for
## the specific language governing rights and limitations under the License.
##
## The Original Code is Reddit.
##
## The Original Developer is the Initial Developer.  The Initial Developer of
## the Original Code is CondeNet, Inc.
##
## All portions of the code written by CondeNet are Copyright (c) 2006-2008
## CondeNet, Inc. All Rights Reserved.
################################################################################

<%!

   ##{_RL

   from r2.models import Link, LinkTag
   from r2.lib.db.operators import desc, asc

   ##}_RL

   from r2.models.subreddit import Default
   from r2.lib.template_helpers import get_domain, static
   from r2.lib.filters import safemarkdown, cleanhtml
   from r2.lib.utils import prettytime
   from r2.lib.strings import strings

 %>

<%namespace file="utils.html" import="separator,plain_link"/>
<%inherit file="printable.html"/>

<%def name="RenderPrintable()">
<%
  css_class = "post"
  if thing.blessed:
    css_class += ' editors-pick'

  if thing.render_full:
    full_article = True
    heading_size = 1
  else:
    full_article = False
    heading_size = 2

  fullname = thing._fullname


##{_RL


  ##url = "http://lesswrong.local:8080/lw/2/why_truth_and/"
  url=thing.url


  #f = open('/home/robert/Desktop/LW/workfile', 'w')

  #f.write("testing\n")

  #f.write(url + "\n")

  #these variables store information about the wikipage currently being scanned
  foundLinkToThisArticle = 0
  foundSequenceCategoryLink = 0
  articleLinksFoundOnthisWikiPage = 0
  indexOfThisArticle = 0
  previousArticleLink = ""
  theLastArticleLinkWeFoundWasTheCurrentArticle = 0
  currentLinkForPreviousButton = ""
  currentLinkForNextButton = ""
  title = ""

  #these variables are the final result of the scan
  thisArticleIsInASequence = 0
  finalIndexForThisArticle = 0
  finalArticleCount = 0
  finalLinkForPreviousButton = ""
  finalLinkForNextButton = ""
  finalSequenceWikipageTitle = ""

  ##import urllib2
  ##for line in urllib2.urlopen('http://wiki.lesswrong.com/wiki.lesswrong.xml'):
  ##for line in open('/home/robert/Desktop/LW/wiki.lesswrong.xml', 'r'):
  ##for line in urllib2.urlopen('http://acceleratingfuture.com/peer/LWcode/wiki.lesswrong.xml'):
  for line in open('../../wiki.lesswrong.xml', 'r'):
    if '<title>' in line or '</title>' in line:
      #first finish processing the previous wiki page
      if foundLinkToThisArticle != 0 and foundSequenceCategoryLink != 0:
        thisArticleIsInASequence = 1
        finalIndexForThisArticle = indexOfThisArticle
        finalArticleCount = articleLinksFoundOnthisWikiPage
        finalLinkForPreviousButton = currentLinkForPreviousButton
        finalLinkForNextButton = currentLinkForNextButton
        finalSequenceWikipageTitle = title
        finalSequenceWikipageTitleWithUnderscores = finalSequenceWikipageTitle.replace(' ', '_');

      #now get the title of the next wiki page
      titleStartPos = line.find('<title>')
      titleEndPos = line.find('</title>')
      title = line[titleStartPos+len('<title>'):titleEndPos]

      #now reset the counter variables
      foundLinkToThisArticle = 0
      foundSequenceCategoryLink = 0
      articleLinksFoundOnthisWikiPage = 0
      indexOfThisArticle = 0;
      previousArticleLink = ""
      theLastArticleLinkWeFoundWasTheCurrentArticle = 0
      #f.write(title + "\n")

    if '[[Category:Sequences]]' in line:
      foundSequenceCategoryLink = 1

    line = line.decode('utf-8')

    if url in line:
      articleLinksFoundOnthisWikiPage = articleLinksFoundOnthisWikiPage + 1;
      foundLinkToThisArticle = 1
      theLastArticleLinkWeFoundWasTheCurrentArticle = 1
      currentLinkForPreviousButton = previousArticleLink
      indexOfThisArticle = articleLinksFoundOnthisWikiPage
      #f.write(title + "\n")

    if 'http://lesswrong.com/lw/' in line:
      articleLinksFoundOnthisWikiPage = articleLinksFoundOnthisWikiPage + 1
      linkStartPos = line.find('[http://lesswrong')
      linkEndPos = line.find(' ', linkStartPos)
      linkWeAreLookingAtNow = line[linkStartPos+len('['):linkEndPos]
      if theLastArticleLinkWeFoundWasTheCurrentArticle != 0:
        currentLinkForNextButton = linkWeAreLookingAtNow
      previousArticleLink = linkWeAreLookingAtNow
      theLastArticleLinkWeFoundWasTheCurrentArticle = 0
      #f.write(linkWeAreLookingAtNow + "\n")


  #bug: the above code won't process the last wikipage in the XML file, because the processing for each page happens when the next title is detected
  #I'm just leaving this bug in for now until the rest of the code is actually working

  #f.close()


  PrevLinkInPromoted = None
  PrevLinkInAll      = None
  PrevLinkInTop      = None
  PrevLinkByAuthor   = None
  PrevLinkByTag      = [] # this is bad code!  the separate arrays should be combined into an object!

  NextLinkInPromoted = None
  NextLinkInAll      = None
  NextLinkInTop      = None
  NextLinkByAuthor   = None
  NextLinkByTag      = []

  CurrentIndexInPromoted = 0
  CurrentIndexInAll      = 0
  CurrentIndexInTop      = 0
  CurrentIndexByAuthor   = 0
  CurrentIndexByTag      = []

  TotalPostsInPromoted   = 0
  TotalPostsInAll        = 0
  TotalPostsInTop        = 0
  TotalPostsByAuthor     = 0
  TotalPostsByTag        = []

  # this is a really stupid and dangerous hack.
  # PrevLinkByTag, NextLinkByTag, and TagNamesByTag should be combined into an object.
  # then having a separate array to store the valid indexes would be unnecessary
  TagNamesByTag          = []
  IndexesByTag           = []
  nextIndexByTag         = 0

  ##q = Link._query(Link.c._id < l._id, Link.c._deleted == False, Link.c._spam == False, Link.c.blessed == True, limit = 1, sort = desc('_id'), data = True)
  ##q = Link._query(Link.c._id < thing._id, Link.c._deleted == False, Link.c._spam == False, Link.c.blessed == True, limit = 1, sort = desc('_id'), data = True)

  #get the previous post by author, sorted by date
  q = Link._query(Link.c._date < thing._date, Link.c._deleted == False, Link.c._spam == False, Link.c.author_id==thing.author_id, limit = 1, sort = desc('_date'), data = True)

  link = None
  results = list(q)
  if results:
    link = results[0]

  if link:
    PrevLinkByAuthor = link.url


  #get the next post by author, sorted by date
  q = Link._query(Link.c._date > thing._date, Link.c._deleted == False, Link.c._spam == False, Link.c.author_id==thing.author_id, limit = 1, sort = asc('_date'), data = True)

  link = None
  results = list(q)
  if results:
    link = results[0]

  if link:
    NextLinkByAuthor = link.url


  #get the previous post in Promoted, sorted by date
  q = Link._query(Link.c._date < thing._date, Link.c._deleted == False, Link.c._spam == False, Link.c.blessed == True, limit = 1, sort = desc('_date'), data = True)

  link = None
  results = list(q)
  if results:
    link = results[0]

  if link:
    PrevLinkInAll = link.url


  #get the next post in Promoted, sorted by date
  q = Link._query(Link.c._date > thing._date, Link.c._deleted == False, Link.c._spam == False, Link.c.blessed == True, limit = 1, sort = asc('_date'), data = True)

  link = None
  results = list(q)
  if results:
    link = results[0]

  if link:
    NextLinkInAll = link.url


  #get the previous post in All, sorted by date
  q = Link._query(Link.c._date < thing._date, Link.c._deleted == False, Link.c._spam == False, limit = 1, sort = desc('_date'), data = True)

  link = None
  results = list(q)
  if results:
    link = results[0]

  if link:
    PrevLinkInAll = link.url


  #get the next post in All, sorted by date
  q = Link._query(Link.c._date > thing._date, Link.c._deleted == False, Link.c._spam == False, limit = 1, sort = asc('_date'), data = True)

  link = None
  results = list(q)
  if results:
    link = results[0]

  if link:
    NextLinkInAll = link.url


  #get the previous post in Top, sorted by date
  q = Link._query(Link.c._date < thing._date, Link.c._deleted == False, Link.c._spam == False, Link.c.top_link == True, limit = 1, sort = desc('_date'), data = True)

  link = None
  results = list(q)
  if results:
    link = results[0]

  if link:
    PrevLinkInTop = link.url


  #get the next post in Top, sorted by date
  q = Link._query(Link.c._date > thing._date, Link.c._deleted == False, Link.c._spam == False, Link.c.top_link == True, limit = 1, sort = asc('_date'), data = True)

  link = None
  results = list(q)
  if results:
    link = results[0]

  if link:
    NextLinkInTop = link.url

  tags = thing.get_tags()

  #debugValue = None

  for tag in tags:
    #debugValue = tag.name

    #get the previous post by tag, sorted by date
    q = LinkTag._query(LinkTag.c._thing2_id == tag._id,
                       LinkTag.c._name == 'tag',
                       LinkTag.c._t1_deleted == False,
                       LinkTag.c._t1_spam == False,
                       LinkTag.c._t1_date < thing._date,
                       limit = 1,
                       sort = desc('_t1_date'),
                       eager_load = True,
                       thing_data = True)

    link = None
    results = list(q)

    if results:
      link = results[0]

    if link:
      PrevLinkByTag.append(link._thing1.url)
    else:
      PrevLinkByTag.append(None)


    #get the next post by tag, sorted by date
    q = LinkTag._query(LinkTag.c._thing2_id == tag._id,
                       LinkTag.c._name == 'tag',
                       LinkTag.c._t1_deleted == False,
                       LinkTag.c._t1_spam == False,
                       LinkTag.c._t1_date > thing._date,
                       limit = 1,
                       sort = asc('_t1_date'),
                       eager_load = True,
                       thing_data = True)

    link = None
    results = list(q)

    if results:
      link = results[0]

    if link:
      NextLinkByTag.append(link._thing1.url)
    else:
      NextLinkByTag.append(None)

    TagNamesByTag.append(tag.name)

    IndexesByTag.append(nextIndexByTag);

    nextIndexByTag = nextIndexByTag + 1



##}_RL

%>

<div id="thingrow_${fullname}" class="${css_class}">
  <h${heading_size}><a href="${thing.url}">${self.title()}</a></h${heading_size}>
  <div class="meta clear">

    %if thing.hide_score:
      <span class="votes">&bull;</span>
    %else:
      <span class="votes">${self.score(thing, thing.likes, label = False)}</span>
    %endif
    ${unsafe(self.author(friend = thing.friend))}
    <span class="date">${prettytime(thing._date)}</span>
  </div><!-- .meta -->
##{_RL
<!--
<div>
  <i><h${heading_size-1}>Part 1 of 13 in the sequence &nbsp; <a href="http://wiki.lesswrong.com/wiki/Mysterious_Answers_to_Mysterious_Questions">Mysterious Answers to Mysterious Questions</a></h${heading_size-1}></i>
<br/>
<br/>
</div>
-->
##}_RL
  <div id="entry_${fullname}" class="content clear">
## The div below is a hack to get the space compressor to leave whitespace in articles alone
    <div class="md">
      %if full_article:
        ${self.article()}
      %else:
        ${self.summary()}
      %endif
    </div>
  </div><!-- .content -->
  <div class="tools clear">
    ${parent.midcol(thing.votable)}
    %if thing.comments_enabled:
      <%
          num_comments = 0 if not thing.num_comments else thing.num_comments
      %>
      <a class="comment" href="${thing.url}#comments">${_('Comments (%d)') % (num_comments)}</a>
    %endif
    <div class="boxright clear">
      <ul class="clear">
        ${self.buttons(comments = False)}
      </ul>
      %if full_article:
        <% tags = thing.get_tags() %>
        %if len(tags):
          <div class="tags">
            <span>Tags:</span>&#32;
            %for tag in thing.get_tags():
              <a href="${tag.path}">${tag.name}</a>${separator(" ")}
            %endfor
          </div>
        %endif
        <img src="${static('mini-landscape.gif')}" alt="" class="landscape" />
      %endif
    </div>
    ## Each link has a hidden status span that is used to indicate voting errors.
    <span id=${"status_"+thing._fullname} class="error" style="display: none;"></span>

##{_RL

<br/>
<br/>




<div class="articlenavigation">

<%!
autoexpand = 0
%>



%if autoexpand == 1:
  <h4>
    <a href="javascript:void(0)" class="dsphead" onclick="dsp(this)">
      <span class="dspchar">(-)</span>&nbsp; Article Navigation
    </a>
  </h4>
  <div style="display: block;" class="dspcontshown">
%else:
  <h4>
    <a href="javascript:void(0)" class="dsphead" onclick="dsp(this)">
      <span class="dspchar">(+)</span>&nbsp; Article Navigation
    </a>
  </h4>
  <div style="display: none;" class="dspcont">
%endif

<ul class="clear">


<li class="clear">
%if PrevLinkByAuthor:
  <a class="nav" href="${PrevLinkByAuthor}"><img src="/static/articlenav-prev.gif" alt="Previous" /></a>
%else:
  <img src="/static/articlenav-prev-grey.gif" alt="Previous" />
%endif
<!--   <span class="place">post ${CurrentIndexByAuthor} of ${TotalPostsByAuthor}</span> -->
  <span class="place">by author</span>
%if NextLinkByAuthor:
  <a class="nav" href="${NextLinkByAuthor}"><img src="/static/articlenav-next.gif" alt="Next" /></a>
%else:
  <img src="/static/articlenav-next-grey.gif" alt="Next" />
%endif
<!--  <span class="type">by &nbsp; ${unsafe(self.author(friend = thing.friend))}</span> -->
  <span class="type">${unsafe(self.author(friend = thing.friend))}</span>
</li>

%if thisArticleIsInASequence == 1:

<li class="clear">
%if finalLinkForPreviousButton:
  <a class="nav" href="${finalLinkForPreviousButton}"><img src="/static/articlenav-prev.gif" alt="Previous" /></a>
%else:
  <img src="/static/articlenav-prev-grey.gif" alt="Previous" />
%endif
<!--   <span class="place">post ${finalIndexForThisArticle} of ${finalArticleCount}</span> -->
  <span class="place">in sequence</span>
%if finalLinkForNextButton:
  <a class="nav" href="${finalLinkForNextButton}"><img src="/static/articlenav-next.gif" alt="Next" /></a>
%else:
  <img src="/static/articlenav-next-grey.gif" alt="Next" />
%endif
<!--  <span class="type">in &nbsp; '<a href="http://wiki.lesswrong.com/wiki/${finalSequenceWikipageTitleWithUnderscores}">${finalSequenceWikipageTitle}</a>' sequence</span> -->
  <span class="type"><a href="http://wiki.lesswrong.com/wiki/${finalSequenceWikipageTitleWithUnderscores}">${finalSequenceWikipageTitle}</a></span>
</li>

%endif

%if PrevLinkInPromoted or NextLinkInPromoted:
<li class="clear">
%if PrevLinkInPromoted:
  <a class="nav" href="${PrevLinkInPromoted}"><img src="/static/articlenav-prev.gif" alt="Previous" /></a>
%else:
  <img src="/static/articlenav-prev-grey.gif" alt="Previous" />
%endif
<!--   <span class="place">post ${CurrentIndexInPromoted} of ${TotalPostsInPromoted}</span> -->
  <span class="place"><a href="http://lesswrong.com/">Promoted Posts</a></span>
%if NextLinkInPromoted:
  <a class="nav" href="${NextLinkInPromoted}"><img src="/static/articlenav-next.gif" alt="Next" /></a>
%else:
<!--  <span class="type">in &nbsp; <a href="http://lesswrong.com/">Promoted Posts</a></span> -->
  <img src="/static/articlenav-next-grey.gif" alt="Next" />
%endif
</li>
%endif


%if PrevLinkInAll or NextLinkInAll:
<li class="clear">
%if PrevLinkInAll:
  <a class="nav" href="${PrevLinkInAll}"><img src="/static/articlenav-prev.gif" alt="Previous" /></a>
%else:
  <img src="/static/articlenav-prev-grey.gif" alt="Previous" />
%endif
<!--   <span class="place">post ${CurrentIndexInAll} of ${TotalPostsInAll}</span> -->
  <span class="place"><a href="http://lesswrong.com/new/">All Posts</a></span>
%if NextLinkInAll:
  <a class="nav" href="${NextLinkInAll}"><img src="/static/articlenav-next.gif" alt="Next" /></a>
%else:
<!--  <span class="type">in &nbsp; <a href="http://lesswrong.com/new/">All Posts</a></span> -->
  <img src="/static/articlenav-next-grey.gif" alt="Next" />
%endif
</li>
%endif


%if PrevLinkInTop or NextLinkInTop:
<li class="clear">
%if PrevLinkInTop:
  <a class="nav" href="${PrevLinkInTop}"><img src="/static/articlenav-prev.gif" alt="Previous" /></a>
%else:
  <img src="/static/articlenav-prev-grey.gif" alt="Previous" />
%endif
<!--   <span class="place">post ${CurrentIndexInTop} of ${TotalPostsInTop}</span> -->
  <span class="place"><a href="http://lesswrong.com/top/">Top Posts</a></span>
%if NextLinkInTop:
  <a class="nav" href="${NextLinkInTop}"><img src="/static/articlenav-next.gif" alt="Next" /></a>
%else:
<!--  <span class="type">in &nbsp; <a href="http://lesswrong.com/top/">Top Posts</a></span> -->
  <img src="/static/articlenav-next-grey.gif" alt="Next" />
%endif
</li>
%endif


%for index in IndexesByTag:
<li class="clear">
%if PrevLinkByTag[index]:
  <a class="nav" href="${PrevLinkByTag[index]}"><img src="/static/articlenav-prev.gif" alt="Previous" /></a>
%else:
  <img src="/static/articlenav-prev-grey.gif" alt="Previous" />
%endif
<!--   <span class="place">post ${CurrentIndexInTop} of ${TotalPostsInTop}</span> -->
  <span class="place">by tag</span>
%if NextLinkByTag[index]:
  <a class="nav" href="${NextLinkByTag[index]}"><img src="/static/articlenav-next.gif" alt="Next" /></a>
%else:
  <img src="/static/articlenav-next-grey.gif" alt="Next" />
%endif
<!--  <span class="type">by tag &nbsp; <a href="http://lesswrong.com/tag/${TagNamesByTag[index]}">${TagNamesByTag[index]}</a></span> -->
  <span class="type"><a href="http://lesswrong.com/tag/${TagNamesByTag[index]}">${TagNamesByTag[index]}</a></span>
</li>
%endfor

</ul>
</div><!-- class="dspcont" -->
</div><!-- class="articlenavigation" -->

##}_RL


  </div><!-- .tools -->
</div><!-- .post -->
</%def>

<%def name="title()">
  ${thing.title}
</%def>

<%def name="article()">
  ${unsafe(cleanhtml(thing.article))}
  <div class="social-sharing-button">
  <!-- AddThis Button BEGIN -->
  <script type="text/javascript">var addthis_pub="lesswrong";</script>
  <a href="http://www.addthis.com/bookmark.php?v=20" onmouseover="return addthis_open(this, '', '[URL]', '[TITLE]')" onmouseout="addthis_close()" onclick="return addthis_sendto()"><img src="http://s7.addthis.com/static/btn/lg-bookmark-en.gif" width="125" height="16" alt="Bookmark and Share" style="border:0"/></a><script type="text/javascript" src="http://s7.addthis.com/js/200/addthis_widget.js"></script>
  <!-- AddThis Button END -->
  </div>
</%def>

<%def name="summary()">
  ${unsafe(cleanhtml(thing._summary()))}
  % if thing._has_more():
    <%call expr="make_link('read_more', 'more', 'more')">
      continue reading &raquo;
    </%call>
  % endif
</%def>

<%def name="numcol()">
  <% num = thing.num %>
  <span class="rank" style="width:$numcolmargin;"
       id="num_${thing._fullname}">
    %if thing.top_link:
      <a class="star" href="/toplinks">
    %endif
      ##placeholder for the number
      $num
    %if thing.top_link:
      </a>
    %endif
  </span>
</%def>

<%def name="make_link(name, css_class, anchor=None)">
  <a id="${name}_${thing._fullname}"
     onmousedown="setClick(this, '${css_class}')"
     class="${css_class} ${ c.user_is_loggedin and 'loggedin' or ''} ${thing.clicked and 'click' or ''}"
     %if c.user.pref_frame:
       href="http://${get_domain(cname = c.cname, subreddit = False)}/goto?id=${thing._id36}"
     %else:
       href="${thing.url}${anchor and ("#" + anchor) or ''}"
     %endif
     %if thing.nofollow:
       rel="nofollow"
     %endif
     %if c.user.pref_newwindow:
       target="_blank"
     %elif c.cname:
       target="_top"
     %endif
     >
     ${caller.body()}
  </a>
</%def>

<%def name="entry()">
  <p class="title" id="titlerow_${thing._fullname}">
    <%call expr="make_link('title', 'title')">
      ${thing.title}
    </%call>
  </p>
  <ul class="flat-list buttons">
    <li class="tagline">${self.tagline()}${separator("|")}</li>
    ${self.buttons()}
    ${self.admintagline()}
  </ul>
  % if thing.render_full:
    <div class="md">
      ${unsafe(cleanhtml(thing.article))}
    </div>
    <% tags = thing.get_tags() %>
    %if len(tags):
      <div class="tags">
        Tags:&#32;<ul class="flat-list">
        %for tag in thing.get_tags():
          <li><a href="${tag.path}">${tag.name}</a>${separator(" ")}</li>
        %endfor
        </ul>
      </div>
    %endif
    <div class="social-sharing-button">
    <!-- AddThis Button BEGIN -->
    <script type="text/javascript">var addthis_pub="lesswrong";</script>
    <a href="http://www.addthis.com/bookmark.php?v=20" onmouseover="return addthis_open(this, '', '[URL]', '[TITLE]')" onmouseout="addthis_close()" onclick="return addthis_sendto()"><img src="http://s7.addthis.com/static/btn/lg-bookmark-en.gif" width="125" height="16" alt="Bookmark and Share" style="border:0"/></a><script type="text/javascript" src="http://s7.addthis.com/js/200/addthis_widget.js"></script>
    <!-- AddThis Button END -->
    </div>
  %else:
    % if hasattr(thing, '_summary'):
      <div class="md">
        ${unsafe(cleanhtml(thing._summary()))}
      </div>
      % if thing._has_more():
        <%call expr="make_link('read_more', 'md', 'more')">
          Continue reading &ldquo;${thing.title}&rdquo;...
        </%call>
      % endif
    %endif
  %endif
  ${self.mediadiv()}
</%def>

<%def name="subreddit()" buffered="True">
  <%
    if c.cname:
       path = "http://" + get_domain(cname = (c.site == thing.subreddit),
                                     subreddit = (c.site != thing.subreddit))
    else:
       path = thing.subreddit.path
    endif
  %>
  <a id="subreddit_${thing._fullname}" href="${path}" class="hover"
     ${'target="_top"'  if c.cname else ''} >
    ${thing.subreddit.name}
  </a>
  <script type="text/javascript">
    sr['${thing._fullname}'] = '${thing.subreddit._fullname}';
  </script>
</%def>

<%def name="domain()">
  <span class="domain">
    (<a href="/domain/${thing.domain}">${thing.domain}</a>)
  </span>
</%def>

<%def name="tagline()">
  <%
    from r2.lib.utils import timeago
    from r2.models import FakeSubreddit

    if isinstance(c.site, FakeSubreddit) or c.site != thing.subreddit:
      taglinetext = _("Submitted %(when)s ago by %(author)s to %(reddit)s")
    else:
      taglinetext = _("Submitted %(when)s ago by %(author)s")
    taglinetext = taglinetext.replace(" ", "&#32;")
  %>
  ${unsafe(taglinetext % dict(reddit = self.subreddit(),
                              when = thing.timesince,
                              author= self.author(friend = thing.friend)))}
</%def>

<%def name="child()">
</%def>

<%def name="buttons(comments=True,delete=True,report=True,ban=True,additional='')">
  <% fullname = thing._fullname %>
  %if comments:
    <%
       if not thing.num_comments:
         # generates "comment" the imperative verb
         com_label = _("Comment")
       else:
         # generates "XX comments" as a noun
         com_label = ungettext("comment", "comments", thing.num_comments)
       %>
    <li class="first">
    ${parent.comment_button("comment", fullname, com_label,
                            thing.num_comments, thing.permalink,
                            newwindow = c.user.pref_newwindow)}
    </li>
  %endif
##  <li>
##    ${plain_link("Feed", "%s/.rss" % thing.url)}
##  </li>
  %if c.user_is_loggedin:
    %if thing.can_submit(c.user):
      <li>
        ${plain_link("Edit", "/edit/%s" % thing._id36)}
      </li>
    %endif
    %if c.user_is_admin:
      <li>
      %if thing.is_blessed():
        ${parent.state_button("unbless", fullname, _("Demote"), \
            "return change_state(this, 'unbless');", _("Demoted"))}
      %else:
        ${parent.state_button("bless", fullname, _("Promote"), \
            "return change_state(this, 'bless');", _("Promoted"))}
      %endif
      </li>
    %endif
    <li>
    %if thing.saved:
       ${parent.state_button("unsave", fullname, _("Unsave"), \
          "return change_state(this, 'unsave');", _("Unsaved"))}
    %else:
       ${parent.state_button("save", fullname, _("Save"), \
          "return change_state(this, 'save');", _("Saved"))}
    %endif
    </li>
    %if not thing.render_full:
      <li>
      %if thing.hidden:
        ${parent.state_button("unhide", fullname, _("Unhide"), \
          "return change_w_callback(this, $ListClass.unhide);", _("Unhidden"))}
      %else:
        ${parent.state_button("hide", fullname, _("Hide"), \
          "return change_w_callback(this, $ListClass.hide);", _("Hidden"))}
      %endif
      </li>
    %endif
  %endif
  ${parent.delete_or_report_buttons(delete=delete,report=report)}
  ${parent.buttons(ban=ban)}
  ${additional}
  ${self.media_embed()}
</%def>


<%def name="media_embed()">
  %if thing.media_object:
  <li>
    <a id="view_embeded_media_a_${thing._fullname}" class="" \
       href="javascript:view_embeded_media('${thing._fullname}', '${thing.media_object}')">\
      <span id="view_embeded_media_span_watch_${thing._fullname}"
            class="watch-play"
            style="display: inline">
        ${_("Watch")}
      </span>
      <span id="view_embeded_media_span_close_${thing._fullname}"
            class="watch-stop"
            style="display: none">
        ${_("Close")}
      </span>
    </a>
  </li>
  %endif
</%def>

<%def name="thumbnail()">
  %if thing.thumbnail:
  <%call expr="make_link('thumbnail', 'thumbnail')">
    <img src="${thing.thumbnail}" alt=""/>
  </%call>
  %endif
</%def>

<%def name="mediadiv()">
  %if thing.media_object:
    <div id="embeded_media_${thing._fullname}"
         class="embededmedia" style="display: none;">
      <p class="error">loading...</p>
    </div>
  %endif
</%def>
